<?php
// Koneksi database
require_once '../db.php';

// Update jumlah jika ada request POST dari fetch()
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['cart_id'], $_POST['jumlah'])) {
    $cart_id = intval($_POST['cart_id']);
    $jumlah = intval($_POST['jumlah']);
    
    if ($cart_id > 0 && $jumlah > 0) {
        $query = $conn->prepare("UPDATE tb_cart SET jumlah = ? WHERE id = ?");
        $query->bind_param("ii", $jumlah, $cart_id);
        $query->execute();
        echo "success";
        exit;
    } else {
        echo "invalid";
        exit;
    }
}

// Validasi ID keranjang (GET)
if (!isset($_GET['id'])) {
    echo "Produk tidak ditemukan.";
    exit;
}

$cart_id = intval($_GET['id']);

// Ambil data keranjang + produk + varian
$query = $conn->prepare("
    SELECT 
        c.id AS cart_id,
        c.jumlah,
        c.foto_thumbnail,
        p.nama_produk,
        p.foto_thumbnail AS produk_foto,
        p.harga,
        p.harga_diskon,
        p.is_diskon,
        v.varian
    FROM tb_cart c
    JOIN tb_adminProduct p ON c.product_id = p.id
    LEFT JOIN tb_varian_product v ON c.varian_id = v.id
    WHERE c.id = ?
");
$query->bind_param("i", $cart_id);
$query->execute();
$result = $query->get_result();
$item = $result->fetch_assoc();

if (!$item) {
    echo "Item tidak ditemukan.";
    exit;
}
?>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Checkout Produk</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .product-img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
        }

        .original-price {
            text-decoration: line-through;
            color: gray;
            font-size: 0.9rem;
        }

        .discounted-price {
            color: red;
            font-weight: bold;
        }

        .quantity-control input {
            width: 60px;
            text-align: center;
        }

        #totalHarga {
            font-size: 1.25rem;
            font-weight: bold;
            margin-top: 10px;
            color: #28a745;
        }
    </style>
    <script>
        // Harga per item sesuai diskon atau tidak, di-escape agar aman di JS
        const hargaPerItem = <?= $item['is_diskon'] ? intval($item['harga_diskon']) : intval($item['harga']) ?>;

        function updateQuantity(change) {
            const qtyInput = document.getElementById('jumlah');
            let qty = parseInt(qtyInput.value);
            qty += change;
            if (qty < 1) qty = 1;
            qtyInput.value = qty;

            // Update ke total harga
            updateTotalHarga(qty);

            const cartId = <?= $item['cart_id'] ?>;

            // Kirim ke server
            const formData = new URLSearchParams();
            formData.append("cart_id", cartId);
            formData.append("jumlah", qty);

            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData.toString()
            })
            .then(response => response.text())
            .then(data => {
                if (data !== "success") {
                    alert("Gagal menyimpan jumlah.");
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        // Update teks total harga
        function updateTotalHarga(qty) {
            const totalHargaEl = document.getElementById('totalHarga');
            const total = hargaPerItem * qty;

            // Format angka ke format rupiah
            const formatted = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(total);
            totalHargaEl.textContent = `Total Harga: ${formatted}`;
        }

        // Inisialisasi saat halaman load
        window.onload = function() {
            const initialQty = parseInt(document.getElementById('jumlah').value);
            updateTotalHarga(initialQty);
        };
    </script>
</head>
<body class="bg-light">
    <?php require 'layout.php'?>
    <div class="container py-5">
        <div class="card shadow">
            <div class="card-body">
                <h3 class="mb-4">Checkout Produk</h3>
                <form action="../checkout-process.php" method="POST">
                    <div class="row mb-4 align-items-center">
                        <div class="col-md-3">
                            <img class="product-img img-fluid" src="../../admin/uploads/<?= htmlspecialchars($item['produk_foto']) ?>" alt="<?= htmlspecialchars($item['nama_produk']) ?>">
                        </div>
                        <div class="col-md-9">
                            <h5><?= htmlspecialchars($item['nama_produk']) ?></h5>

                            <?php if (!empty($item['varian'])): ?>
                                <p class="mb-1"><strong>Varian:</strong> <?= htmlspecialchars($item['varian']) ?></p>
                            <?php endif; ?>

                            <div class="mb-2">
                                <?php if ($item['is_diskon']): ?>
                                    <span class="original-price me-2">Rp<?= number_format($item['harga'], 0, ',', '.') ?></span>
                                    <span class="discounted-price">Rp<?= number_format($item['harga_diskon'], 0, ',', '.') ?></span>
                                <?php else: ?>
                                    <span class="fw-bold">Rp<?= number_format($item['harga'], 0, ',', '.') ?></span>
                                <?php endif; ?>
                            </div>

                            <div class="d-flex align-items-center quantity-control">
                                <label class="me-2 mb-0">Jumlah:</label>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="updateQuantity(-1)">-</button>
                                <input type="text" class="form-control mx-2" name="jumlah" id="jumlah" value="<?= intval($item['jumlah']) ?>" readonly>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="updateQuantity(1)">+</button>
                            </div>

                            <div id="totalHarga"></div>
                        </div>
                    </div>

                    <!-- Alamat Pengiriman -->
                    <div class="mb-3">
                        <label for="alamat" class="form-label">Alamat Pengiriman</label>
                        <textarea name="alamat" id="alamat" class="form-control" rows="3" required></textarea>
                    </div>

                    <!-- Metode Pembayaran -->
                    <div class="mb-3">
                        <label for="metode_pembayaran" class="form-label">Metode Pembayaran</label>
                        <select name="metode_pembayaran" id="metode_pembayaran" class="form-select" required>
                            <option value="">-- Pilih --</option>
                            <option value="transfer_bank">Transfer Bank</option>
                            <option value="cod">Cash on Delivery</option>
                            <option value="ewallet">E-Wallet (OVO, GoPay, dll)</option>
                        </select>
                    </div>

                    <!-- Catatan -->
                    <div class="mb-3">
                        <label for="catatan" class="form-label">Catatan Pembelian (Opsional)</label>
                        <textarea name="catatan" id="catatan" class="form-control" rows="2"></textarea>
                    </div>

                    <!-- Voucher -->
                    <div class="mb-3">
                        <label for="voucher" class="form-label">Kode Voucher</label>
                        <input type="text" name="voucher" id="voucher" class="form-control" placeholder="Masukkan kode voucher jika ada">
                    </div>

                    <!-- Hidden input -->
                    <input type="hidden" name="cart_id" value="<?= $item['cart_id'] ?>">

                    <div class="text-end">
                        <button type="submit" class="btn btn-success">Lanjut Bayar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
